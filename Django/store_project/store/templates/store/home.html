{% extends 'store/base.html' %}
{% load static cart_tags %}

{% block content %}

<!-- Scrolling product price ticker -->
<div class="scrolling-items bg-gradient-dark text-white py-3 px-4 mb-5 rounded-lg shadow-lg">
  <div class="scrolling-text">
    <div class="scrolling-track">
      {% for product in products %}
        {% if product.price_set.first %}
          <span class="me-5 ticker-item">
            <i class="fas fa-tag me-2"></i>{{ product.name }} - KSH {{ product.price_set.first.price }}
          </span>
        {% endif %}
      {% endfor %}
      {% for product in products %}
        {% if product.price_set.first %}
          <span class="me-5 ticker-item">
            <i class="fas fa-tag me-2"></i>{{ product.name }} - KSH {{ product.price_set.first.price }}
          </span>
        {% endif %}
      {% endfor %}
    </div>
  </div>
</div>

<!-- Toast Notification Container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="toastNotification" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Notification</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body"></div>
  </div>
</div>

<style>
/* Scrolling Ticker */
.scrolling-items {
  overflow: hidden;
  position: relative;
  height: 60px;
  line-height: 60px;
  background: linear-gradient(90deg, #1e3a8a, #3b82f6);
  color: #ffffff;
  font-family: 'Poppins', sans-serif;
  border-radius: 12px;
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
  width: 100%;
  transition: transform 0.3s ease;
}

.scrolling-items:hover {
  transform: scale(1.02);
}

.scrolling-text {
  overflow: hidden;
  position: relative;
  width: 100%;
}

.scrolling-track {
  display: inline-block;
  white-space: nowrap;
  animation: scroll-left 25s linear infinite;
  font-size: 1.3rem;
  font-weight: 600;
  letter-spacing: 0.8px;
}

.ticker-item {
  display: inline-block;
  margin-right: 3rem;
  transition: color 0.3s ease, transform 0.3s ease;
}

.ticker-item:hover {
  color: #f0f0f0;
  transform: translateY(-2px);
}

@keyframes scroll-left {
  0% {
    transform: translateX(0%);
  }
  100% {
    transform: translateX(-50%);
  }
}

/* Product Card Styling */
.card {
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  border-radius: 15px !important;
  overflow: hidden;
}

.card:hover {
  transform: translateY(-10px);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15), 0 0 15px rgba(59, 130, 246, 0.3) !important; /* Glow effect */
}

.card-img-top {
  transition: transform 0.3s ease;
}

.card:hover .card-img-top {
  transform: scale(1.05);
}

.card-body {
  background: linear-gradient(180deg, #f8f9fa, #ffffff);
}

.card-title {
  background: linear-gradient(90deg, #3b82f6, #8b5cf6); /* Gradient for product names */
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-weight: 700; /* Premium font-weight */
  letter-spacing: 1.2px; /* Premium letter-spacing */
  font-family: 'Poppins', sans-serif;
  margin-bottom: 1rem;
}

.btn-outline-primary, .btn-outline-danger, .btn-success {
  border-radius: 8px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.btn-outline-primary:hover {
  background-color: #3b82f6;
  color: white;
}

.btn-outline-danger:hover {
  background-color: #dc3545;
  color: white;
}

.btn-success {
  background: linear-gradient(90deg, #22c55e, #16a34a);
}

.btn-success:hover {
  background: linear-gradient(90deg, #16a34a, #22c55e);
}

.btn-success:disabled, .btn-outline-primary:disabled, .btn-outline-danger:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.payment-options .form-check-label {
  cursor: pointer;
  transition: color 0.3s ease;
}

.payment-options .form-check-label:hover {
  color: #3b82f6;
}

.form-control {
  border-radius: 8px;
  transition: border-color 0.3s ease;
}

.form-control:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
}

.form-control.is-invalid {
  border-color: #dc3545;
}

.invalid-feedback {
  font-size: 0.85rem;
}
</style>

<!-- Products Grid -->
<div class="container mt-5">
  <h1 class="mb-4 text-center text-primary fw-bold" style="font-family: 'Poppins', sans-serif;">
    Welcome to Transdigital
  </h1>
  <p class="text-center text-muted mb-5" style="font-size: 1.2rem;">Discover Our Premium Collection Below</p>

  <div class="row row-cols-1 row-cols-md-3 g-4">
    {% for product in products %}
      <div class="col">
        <div class="card h-100 shadow-lg border-0 rounded-lg">
          {% if product.thumbnail %}
            <img src="{{ product.thumbnail.url }}" class="card-img-top rounded-top" alt="{{ product.name }}" style="object-fit: cover; height: 220px;">
          {% else %}
            <div class="card-img-top d-flex justify-content-center align-items-center bg-light rounded-top" style="height: 220px;">
              <span class="text-muted">No Image Available</span>
            </div>
          {% endif %}
          <div class="card-body d-flex flex-column p-4">
            <h5 class="card-title">{{ product.name }}</h5>
            <p class="card-text text-muted">{{ product.description|truncatewords:20 }}</p>

            {% for price in product.price_set.all %}
              <div class="mt-auto">
                <hr class="my-3">
                <p class="mb-1"><strong>Price:</strong> KSH {{ price.price }}</p>
                <p class="mb-2 cart-count" data-price-id="{{ price.id }}">
                  <strong>In Cart:</strong> 🛒 <span class="item-count">{{ cart|get_item:price.id|default:"0" }}</span> item(s)
                </p>

                <div class="d-flex flex-wrap gap-2 mb-3">
                  <form class="add-to-cart-form" action="{% url 'add_to_cart' price.id %}" method="POST" data-price-id="{{ price.id }}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-primary btn-sm add-to-cart-btn">
                      🛒 Add to Cart
                    </button>
                  </form>

                  {% if cart|get_item:price.id %}
                    <form class="remove-from-cart-form" action="{% url 'remove_from_cart' price.id %}" method="POST" data-price-id="{{ price.id }}">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-outline-danger btn-sm remove-from-cart-btn">
                        <i class="fas fa-trash-alt me-1"></i> Remove
                      </button>
                    </form>
                  {% else %}
                    <form class="remove-from-cart-form d-none" action="{% url 'remove_from_cart' price.id %}" method="POST" data-price-id="{{ price.id }}">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-outline-danger btn-sm remove-from-cart-btn">
                        <i class="fas fa-trash-alt me-1"></i> Remove
                      </button>
                    </form>
                  {% endif %}
                </div>

                <form id="payment-form-{{ price.id }}" action="{% url 'create_checkout' price.id %}" method="POST">
                  {% csrf_token %}
                  <div class="payment-options">
                    <div class="form-check mb-2">
                      <input class="form-check-input" type="radio" name="payment_method" value="stripe" id="stripe-{{ price.id }}" checked>
                      <label class="form-check-label" for="stripe-{{ price.id }}">
                        <i class="fas fa-credit-card me-1"></i> Pay with Card
                      </label>
                    </div>
                    <div class="form-check mb-2">
                      <input class="form-check-input" type="radio" name="payment_method" value="mpesa" id="mpesa-{{ price.id }}">
                      <label class="form-check-label" for="mpesa-{{ price.id }}">
                        <i class="fas fa-mobile-alt me-1"></i> Pay with M-Pesa
                      </label>
                    </div>
                    <input type="text" name="phone_number" class="form-control mt-2" id="phone-input-{{ price.id }}" placeholder="2547XXXXXXXX" style="display: none;" pattern="2547[0-9]{8}" title="Phone number must start with 2547 followed by 8 digits">
                    <div class="invalid-feedback" id="phone-error-{{ price.id }}">Please enter a valid phone number (e.g., 2547XXXXXXXX).</div>
                    <button type="submit" class="btn btn-success w-100 mt-3" id="checkout-btn-{{ price.id }}">
                      <i class="fas fa-check-circle me-1"></i> Checkout
                    </button>
                  </div>
                </form>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    {% empty %}
      <p class="text-center text-muted">No Products Available at the Moment.</p>
    {% endfor %}
  </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<script>
const stripe = Stripe('{{ STRIPE_PUBLISHABLE_KEY|default:"" }}');

function showToast(message, isError = false) {
  const toast = document.getElementById('toastNotification');
  const toastBody = toast.querySelector('.toast-body');
  toastBody.textContent = message;
  toast.classList.remove('bg-success', 'bg-danger', 'text-white');
  toast.classList.add(isError ? 'bg-danger' : 'bg-success', 'text-white');
  const bsToast = new bootstrap.Toast(toast);
  bsToast.show();
}

// Handle Add/Remove Cart Actions via AJAX
document.querySelectorAll('.add-to-cart-form, .remove-from-cart-form').forEach(form => {
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const priceId = form.dataset.priceId;
    const isAddAction = form.classList.contains('add-to-cart-form');
    const button = form.querySelector('button');
    const cartCountElement = document.querySelector(`.cart-count[data-price-id="${priceId}"] .item-count`);
    const removeForm = document.querySelector(`.remove-from-cart-form[data-price-id="${priceId}"]`);

    button.disabled = true;
    button.innerHTML = isAddAction ? '<i class="fas fa-spinner fa-spin me-1"></i> Adding...' : '<i class="fas fa-spinner fa-spin me-1"></i> Removing...';

    try {
      const formData = new FormData(form);
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Accept': 'application/json'
        }
      });

      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }

      const result = await response.json();
      console.log(`${isAddAction ? 'Add' : 'Remove'} response:`, result);

      if (result.success) {
        // Update cart count
        cartCountElement.textContent = result.cart_count || 0;

        // Show/hide remove button based on cart count
        if (result.cart_count > 0) {
          removeForm.classList.remove('d-none');
        } else {
          removeForm.classList.add('d-none');
        }

        showToast(isAddAction ? 'Item added to cart!' : 'Item removed from cart!', false);
      } else {
        showToast(result.error || 'An error occurred. Please try again.', true);
        // Fallback: Reload page if critical error
        if (result.error && result.error.includes('session')) {
          showToast('Session error detected. Reloading page...', true);
          setTimeout(() => window.location.reload(), 2000);
        }
      }
    } catch (error) {
      console.error(`${isAddAction ? 'Add' : 'Remove'} error:`, error);
      showToast(`Failed to ${isAddAction ? 'add' : 'remove'} item: ${error.message}`, true);
      // Fallback: Reload page for network errors
      setTimeout(() => window.location.reload(), 2000);
    } finally {
      button.disabled = false;
      button.innerHTML = isAddAction ? '🛒 Add to Cart' : '<i class="fas fa-trash-alt me-1"></i> Remove';
    }
  });
});

// Handle Checkout Form Submission
document.querySelectorAll('[id^="payment-form-"]').forEach(form => {
  const priceId = form.id.split('-')[2];
  const phoneInput = document.getElementById(`phone-input-${priceId}`);
  const checkoutBtn = document.getElementById(`checkout-btn-${priceId}`);
  const phoneError = document.getElementById(`phone-error-${priceId}`);

  form.querySelectorAll('input[name="payment_method"]').forEach(input => {
    input.addEventListener('change', () => {
      const isMpesa = input.value === 'mpesa';
      phoneInput.style.display = isMpesa ? 'block' : 'none';
      phoneInput.required = isMpesa;
      phoneInput.classList.remove('is-invalid');
      phoneError.style.display = 'none';
    });
  });

  form.addEventListener('submit', async function(e) {
    e.preventDefault();

    // Client-side phone number validation for M-Pesa
    const isMpesa = form.querySelector('input[name="payment_method"]:checked').value === 'mpesa';
    if (isMpesa && !phoneInput.value.match(/^2547[0-9]{8}$/)) {
      phoneInput.classList.add('is-invalid');
      phoneError.style.display = 'block';
      showToast('Invalid phone number. Please use format 2547XXXXXXXX.', true);
      return;
    }

    checkoutBtn.disabled = true;
    checkoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processing...';

    try {
      const formData = new FormData(this);
      const response = await fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: { 
          'X-CSRFToken': '{{ csrf_token }}',
          'Accept': 'application/json'
        }
      });

      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }

      const text = await response.text(); // Get raw response text for debugging
      console.log('Raw checkout response:', text);

      let result;
      try {
        result = JSON.parse(text);
      } catch (parseError) {
        throw new Error('Invalid JSON response: ' + parseError.message);
      }
      console.log('Parsed checkout response:', result);

      if (result.redirect_url) {
        showToast('Redirecting to payment...', false);
        setTimeout(() => {
          try {
            window.location.href = result.redirect_url;
          } catch (err) {
            console.error('Redirect error:', err);
            showToast('Failed to redirect to payment page. Please try again.', true);
          }
        }, 1000);
      } else if (result.message) {
        showToast(result.message, false);
      } else {
        showToast('Error: ' + (result.error || 'Unknown error occurred'), true);
      }
    } catch (error) {
      console.error('Checkout error:', error);
      showToast('An error occurred during checkout: ' + error.message, true);
      // Fallback: Reload page for critical errors
      setTimeout(() => window.location.reload(), 2000);
    } finally {
      checkoutBtn.disabled = false;
      checkoutBtn.innerHTML = '<i class="fas fa-check-circle me-1"></i> Checkout';
    }
  });
});
</script>

{% endblock %}